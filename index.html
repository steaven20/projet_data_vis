<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>HeadMap.js</title>
    <!--Framework-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <div id="heatmap"></div>
    <div id="heatmap1"></div>
    <div id="heatmap2">
        <img src="./src_heatmap/Nuke.png" id="imgs" style="display:none"></img>
    </div>
    <script type="text/javascript">
    //generer data au hasard
    function geneDataHasard(width,height){
        // now generate some random data
        var points = [];
        var max = 100;
        var min = 0;
        var len = 100;
        var maxWeight = 100;

        while (len--) {
            var val = Math.floor(Math.random() * maxWeight);
            max = Math.max(max, val);
            min = Math.min(min, val);
            var point = {
            //这里可以自定义
            x: Math.floor(Math.random() * width),
            y: Math.floor(Math.random() * height),
            value: val
            };
            points.push(point);
            
        }
        return points;
    }
    function genereHeatmap(points){
      var radius = 20;
      var width = 1000;
      var height = 1000;

      var canvas = d3
        .select("#heatmap")
        .append("canvas")
        .attr("width", width)
        .attr("height", height);

      var context = canvas.node().getContext("2d");

      
      
      //draw each circle
      points.forEach((d) => {
        // 开始为每个数据点绘制圆，圆心为[x,y]，半径为radius
        context.beginPath();
        context.arc(d.x, d.y, radius, 0, 2 * Math.PI);
        context.fillStyle = "red";
        // 给圆加上渐变色，圆心至边的渐变色为#000至透明
        let radialGradient = context.createRadialGradient(
          d.x,
          d.y,
          0,
          d.x,
          d.y,
          radius
        );
        radialGradient.addColorStop(0, "rgba(0,0,0,1)");
        radialGradient.addColorStop(1, "rgba(0,0,0,0)");
        context.fillStyle = radialGradient;
        // 给圆加上透明度，值为globalAlpha
        context.globalAlpha = 0.7;

        context.fill();
        context.closePath();
      });

      //creer a line of color 256*1
      // 创建一条宽为256,高为1的像素带，颜色可自定义。
      var w = 256;
      var h = 1;

      function getColorPaint() {
        var paletteCanvas = d3
          .select("#heatmap1")
          .append("canvas")
          .attr("width", w)
          .attr("height", h);

        var ctx = paletteCanvas.node().getContext("2d");

        //define color
        let gradientConfig = {
          "0.0": "#6E32C2",
          "0.1": "#1890FF",
          "0.2": "#12CCCC",
          "0.3": "#80FF73",
          "0.4": "#FAFFA8",
          "0.5": "#FFC838",
          "0.6": "#FF8C12",
          "0.7": "#FA541C",
          "1.0": "#F51D27"
        };
        //creer un bound pixcel 256*1
        let linearGradient = ctx.createLinearGradient(0, 0, w, h);
        for (let key in gradientConfig) {
          // 绘制彩色渐变色条
          linearGradient.addColorStop(key, gradientConfig[key]);
        }
        ctx.fillStyle = linearGradient;
        ctx.fillRect(0, 0, w, h);
        return ctx.getImageData(0, 0, width, height).data;
      }

      
      let palette = getColorPaint();

      let pointImg = context.getImageData(0, 0, width, height);
      let pointImgData = pointImg.data;

      let pm1 = new Promise((res,rej)=>{
            for (var i = 3; i < pointImgData.length; i += 4) {
                let alpha = pointImgData[i];
                let offset = alpha * 4;
                pointImgData[i - 3] = palette[offset];
                pointImgData[i - 2] = palette[offset + 1];
                pointImgData[i - 1] = palette[offset + 2];
            }
            pointImg.data = pointImgData;
            res();
      });
      
      
        
        //draw heatmap with backgroud map
        var bgImg = new Image();
        bgImg= document.getElementById("imgs");
        
        let pm2 = new Promise((res,rej)=>{
            bgImg.onload = ()=>{
                context.clearRect(0,0,width,height);
                res();
            }
        });
      
        let drawAllImg = Promise.all([pm1, pm2]).then((res)=>{
            context.putImageData(pointImg, 0, 0);
            context.drawImage(bgImg, 0, 0, width, height);
        });
    }

    var listpoint = geneDataHasard(1000,1000);
    genereHeatmap(listpoint);
    console.log(listpoint);

      
      
    </script>
  </body>
</html>
